name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Package
    runs-on: macos-14
    timeout-minutes: 60
    permissions:
      contents: read
    strategy:
      matrix:
        arch: [arm64, x86_64]
        include:
          - arch: arm64
            sdk: macosx
            destination: 'platform=macOS,arch=arm64'
            suffix: '-arm64'
          - arch: x86_64
            sdk: macosx
            destination: 'platform=macOS,arch=x86_64'
            suffix: '-x86_64'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Get version from tag
        id: tag_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Build GoToShell
        run: |
          xcodebuild clean build \
            -project GoToShell.xcodeproj \
            -target GoToShell \
            -configuration Release \
            -sdk ${{ matrix.sdk }} \
            -destination "${{ matrix.destination }}" \
            SYMROOT=./build \
            OBJROOT=./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO
      
      - name: Build GoToShellHelper
        run: |
          xcodebuild build \
            -project GoToShell.xcodeproj \
            -target GoToShellHelper \
            -configuration Release \
            -sdk ${{ matrix.sdk }} \
            -destination "${{ matrix.destination }}" \
            SYMROOT=./build \
            OBJROOT=./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO
      
      - name: Prepare app bundle
        run: |
          APP_PATH="./build/Release/GoToShell.app"
          HELPER_PATH="./build/Release/GoToShellHelper.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: GoToShell.app not found at $APP_PATH"
            ls -la ./build/Release/ 2>/dev/null || echo "Build directory structure:"
            find ./build -name "*.app" -type d 2>/dev/null || true
            exit 1
          fi
          
          if [ ! -d "$HELPER_PATH" ]; then
            echo "Error: GoToShellHelper.app not found at $HELPER_PATH"
            ls -la ./build/Release/ 2>/dev/null || echo "Build directory structure:"
            find ./build -name "*.app" -type d 2>/dev/null || true
            exit 1
          fi
          
          # Copy main app
          cp -R "$APP_PATH" ./GoToShell.app
          
          # Copy helper app to MacOS directory (not Resources!)
          mkdir -p GoToShell.app/Contents/MacOS
          cp -R "$HELPER_PATH" GoToShell.app/Contents/MacOS/
          
          # Ad-hoc sign both apps
          codesign --force --deep --sign - GoToShell.app/Contents/MacOS/GoToShellHelper.app
          codesign --force --deep --sign - GoToShell.app
          
          # Verify signing
          codesign -dv GoToShell.app/Contents/MacOS/GoToShellHelper.app
          codesign -dv GoToShell.app
      
      - name: Install create-dmg
        run: |
          brew install create-dmg || echo "create-dmg may already be installed"
      
      - name: Create DMG
        run: |
          DMG_NAME="GoToShell-${{ steps.tag_version.outputs.version }}${{ matrix.suffix }}.dmg"
          create-dmg \
            --volname "GoToShell" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "GoToShell.app" 200 190 \
            --hide-extension "GoToShell.app" \
            --app-drop-link 600 185 \
            "$DMG_NAME" \
            GoToShell.app
      
      - name: Generate checksum
        run: |
          DMG_NAME="GoToShell-${{ steps.tag_version.outputs.version }}${{ matrix.suffix }}.dmg"
          shasum -a 256 "$DMG_NAME" > "$DMG_NAME.sha256"
          cat "$DMG_NAME.sha256"
      
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: dmg-${{ matrix.arch }}
          path: |
            GoToShell-${{ steps.tag_version.outputs.version }}${{ matrix.suffix }}.dmg
            GoToShell-${{ steps.tag_version.outputs.version }}${{ matrix.suffix }}.dmg.sha256
          retention-days: 90
  
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Get version from tag
        id: tag_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Tag: $GITHUB_REF"
      
      - name: List artifacts
        run: |
          echo "Artifacts structure:"
          find artifacts -type f 2>/dev/null | sort || echo "No artifacts found"
          echo ""
          echo "Checking for DMG files:"
          find artifacts -name "*.dmg" 2>/dev/null || echo "No DMG files found"
          echo ""
          echo "Checking for checksum files:"
          find artifacts -name "*.sha256" 2>/dev/null || echo "No checksum files found"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/dmg-arm64/*.dmg
            artifacts/dmg-arm64/*.sha256
            artifacts/dmg-x86_64/*.dmg
            artifacts/dmg-x86_64/*.sha256
          tag_name: v${{ steps.tag_version.outputs.version }}
          name: Release v${{ steps.tag_version.outputs.version }}
          body: |
            ## GoToShell v${{ steps.tag_version.outputs.version }}
            
            ### Downloads
            
            - **Apple Silicon (arm64)**: [GoToShell-${{ steps.tag_version.outputs.version }}-arm64.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ steps.tag_version.outputs.version }}/GoToShell-${{ steps.tag_version.outputs.version }}-arm64.dmg)
            - **Intel (x86_64)**: [GoToShell-${{ steps.tag_version.outputs.version }}-x86_64.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ steps.tag_version.outputs.version }}/GoToShell-${{ steps.tag_version.outputs.version }}-x86_64.dmg)
            
            ### Checksums
            
            See the `.sha256` files for verification.
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

